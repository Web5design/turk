<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Getting started with the Turk Framework &mdash; Turk v0.1.1 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '#',
        VERSION:     '0.1.1',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="top" title="Turk v0.1.1 documentation" href="index.html" />
    <link rel="next" title="Configuring Turk" href="configuration.html" />
    <link rel="prev" title="Overview" href="overview.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="configuration.html" title="Configuring Turk"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="overview.html" title="Overview"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Turk v0.1.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="getting-started-with-the-turk-framework">
<h1>Getting started with the Turk Framework<a class="headerlink" href="#getting-started-with-the-turk-framework" title="Permalink to this headline">¶</a></h1>
<div class="section" id="installing">
<span id="getting-started"></span><h2>Installing<a class="headerlink" href="#installing" title="Permalink to this headline">¶</a></h2>
<p>Turk is a package on the Python Package Index (<a class="reference external" href="http://pypi.python.org/pypi">http://pypi.python.org/pypi</a>), and
can be installed using the easy_install or pip command-line tools:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>easy_install Turk

<span class="nv">$ </span>pip install Turk
</pre></div>
</div>
<p>It can also be installed from source, by downloading the latest source archive
from a variety of places and using the included setup script:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>tar xvzf Turk-0.1.1.tar.gz
<span class="nv">$ </span><span class="nb">cd </span>Turk-0.1.1/
<span class="nv">$ </span><span class="o">[</span>sudo<span class="o">]</span> python setup.py install
</pre></div>
</div>
<p>Needless to say, Python needs to be installed to do this. Turk works with any
version in the 2.5-2.6 series, which are installed by default on many platforms.
The other main dependencies are the D-Bus library and its python bindings (usually
called python-dbus). These can be obtained from <a class="reference external" href="http://dbus.freedesktop.org/releases/">freedesktop.org</a>.</p>
</div>
<div class="section" id="setting-up-the-configuration">
<h2>Setting up the configuration<a class="headerlink" href="#setting-up-the-configuration" title="Permalink to this headline">¶</a></h2>
<p>Setting up a customized configuration file is a very important step. This file
is not only used to configure the framework to work properly on your system, but
also to organize drivers to be run and servers to connect to. It&#8217;s written in
YAML <a class="footnote-reference" href="#yaml" id="id1">[1]</a>, and can be placed anywhere on the system.</p>
<div class="section" id="why-use-yaml">
<h3>Why use YAML?<a class="headerlink" href="#why-use-yaml" title="Permalink to this headline">¶</a></h3>
<p>According to the YAML website:</p>
<blockquote>
YAML™ (rhymes with “camel”) is a human-friendly, cross language, Unicode
based data serialization language designed around the common native data
types of agile programming languages. It is broadly useful for programming
needs ranging from configuration files to Internet messaging to object
persistence to data auditing.</blockquote>
<p>Many other data formats are used for software configuration, including XML, INI files,
and programming languages themselves. However, YAML has two significant
advantages, namely that it is one of the most human-readable formats, and that
it maps well to many logical data types. This allows the configuration file to
be easily edited by both users and software.</p>
</div>
<div class="section" id="example-configuration">
<h3>Example Configuration<a class="headerlink" href="#example-configuration" title="Permalink to this headline">¶</a></h3>
<p>The configuration file has a set of known defaults, which means an empty file
will result in a set of reasonably sane values being used. However, these values
may change between versions, and shouldn&#8217;t be relied upon for important
settings. A safe method is to start with a configuration that specifies all
values as the default, and change them as necessary. That way, when the software
is upgraded, only new values will be unspecified, and should be set to
non-disruptive values (i.e. new features will be turned off by default).</p>
<p>The following is a basic template to start off with:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># Global configuration</span>
<span class="l-Scalar-Plain">global</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">bus</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">SessionBus</span>

<span class="c1"># control interface and launcher (corectl.py)</span>
<span class="l-Scalar-Plain">turkctl</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">pidfile</span><span class="p-Indicator">:</span> <span class="s">&#39;/var/run/turk.pid&#39;</span>
    <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>

<span class="c1"># bridge (handles XMPP relaying)</span>
<span class="l-Scalar-Plain">bridge</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">server</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">macpro.local</span>
    <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5222</span>
    <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">platform@macpro.local</span>
    <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">password</span>
    <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>

<span class="c1"># spawner (starts/stops and manages drivers)</span>
<span class="l-Scalar-Plain">spawner</span><span class="p-Indicator">:</span>
    <span class="c1"># Location of drivers (prefixed to all driver filenames)</span>
    <span class="l-Scalar-Plain">drivers</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/usr/share/turk/drivers</span>

    <span class="c1"># Add drivers that should be automatically started here along with their</span>
    <span class="c1"># environment variables and command line arguments</span>
    <span class="l-Scalar-Plain">autostart</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span>
        <span class="p-Indicator">{</span><span class="s">&#39;device_id&#39;</span><span class="p-Indicator">:</span> <span class="nv">1</span><span class="p-Indicator">,</span> <span class="s">&#39;filename&#39;</span><span class="p-Indicator">:</span> <span class="s">&#39;tick.py&#39;</span><span class="p-Indicator">,</span> <span class="s">&#39;env&#39;</span><span class="p-Indicator">:</span> <span class="p-Indicator">{},</span> <span class="s">&#39;args&#39;</span><span class="p-Indicator">:</span> <span class="p-Indicator">[]},</span>
        <span class="c1">#{&#39;device_id&#39;: 2, &#39;filename&#39;:&#39;rgb_lamp.py&#39;, &#39;env&#39;:{&#39;DEVICE_ADDRESS&#39;:&#39;0xFF&#39;}, &#39;args&#39;: []},</span>
    <span class="p-Indicator">]</span>
    <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>

<span class="c1"># xbeed (handles XBee communication)</span>
<span class="l-Scalar-Plain">xbeed</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">xbee0</span>
    <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="s">&#39;/dev/ttys8&#39;</span>
    <span class="l-Scalar-Plain">baudrate</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9600</span>
    <span class="l-Scalar-Plain">escaping</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
    <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="writing-a-simple-driver">
<h2>Writing a simple driver<a class="headerlink" href="#writing-a-simple-driver" title="Permalink to this headline">¶</a></h2>
<p>Although the framework comes with drivers for some simple tasks such as fetching
the current date and time, and controlling simple wireless devices, most
projects will need their own custom drivers.</p>
<p>Drivers are meant to be a way of translating the XML protocol used by Turk
applications into another protocol, using a network or serial interface, or a
web API. A web application can send XMPP messages to a predefined JID <a class="footnote-reference" href="#jid" id="id2">[2]</a>, and
the framework will forward those messages to the correct driver. The drivers can
send out their own messages, and any number of applications can subscribe to
these updates.</p>
<p>Drivers are usually started by adding a listing to the configuration file that
specifies the location of the file to run, any environment variables or
command-line arguments it needs, and a unique identification number, or &#8220;device
ID&#8221;. This ID represents the abstracted &#8220;device&#8221; that the driver controls, and
allows multiple drivers of the same type to be run at once. An example of such a
listing can be seen in the sample configuration file above, in the autostart
section.</p>
<p>Once started, communication between the driver and the rest of the framework is
done through the D-Bus protocol. This allows drivers to use other services in
the framework through remote method calls, and to receive messages through
signals. For more information on how D-Bus method calls and signals work, read
<a class="reference external" href="http://www.freedesktop.org/wiki/IntroductionToDBus">this introduction to D-Bus</a>.</p>
<div class="section" id="example-driver">
<h3>Example Driver<a class="headerlink" href="#example-driver" title="Permalink to this headline">¶</a></h3>
<p>The following is an example of a simple self-contained driver, written in
Python. It uses both the Bridge API to receive updates from applications, and
the XBee service to send binary packets to a wireless device.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#! /usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">gobject</span>
<span class="kn">import</span> <span class="nn">dbus</span>
<span class="kn">import</span> <span class="nn">dbus.mainloop.glib</span>
<span class="kn">from</span> <span class="nn">turk.xbeed</span> <span class="kn">import</span> <span class="n">xbeed</span>
<span class="kn">from</span> <span class="nn">xml.dom.minidom</span> <span class="kn">import</span> <span class="n">parseString</span>
<span class="kn">import</span> <span class="nn">turk</span>

<span class="k">class</span> <span class="nc">RGBLamp</span><span class="p">(</span><span class="n">dbus</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">Object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_id</span><span class="p">,</span> <span class="n">device_addr</span><span class="p">,</span> <span class="n">bus</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initializes the driver and connects to any relevant signals &quot;&quot;&quot;</span>
        <span class="n">dbus</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">Object</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="s">&#39;/Drivers/RGBLamp/</span><span class="si">%X</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">device_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">device_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_addr</span> <span class="o">=</span> <span class="n">device_addr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span>

        <span class="c"># Get proxy for XBee interface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xbee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">xbeed</span><span class="o">.</span><span class="n">XBEED_SERVICE</span><span class="p">,</span> <span class="n">xbeed</span><span class="o">.</span><span class="n">XBEED_DAEMON_OBJECT</span> <span class="o">%</span> <span class="s">&#39;xbee0&#39;</span><span class="p">)</span>

        <span class="c"># Register update signal handler</span>
        <span class="n">listen</span> <span class="o">=</span> <span class="s">&#39;/Bridge/Drivers/</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">add_signal_receiver</span><span class="p">(</span><span class="n">handler_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">,</span>
                                     <span class="n">bus_name</span><span class="o">=</span><span class="n">turk</span><span class="o">.</span><span class="n">TURK_BRIDGE_SERVICE</span><span class="p">,</span>
                                     <span class="n">signal_name</span><span class="o">=</span><span class="s">&#39;Update&#39;</span><span class="p">,</span>
                                     <span class="n">path</span><span class="o">=</span><span class="n">listen</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Called every time an update for this driver is received. &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">parseString</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>

            <span class="n">command</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">&#39;command&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ctype</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ctype</span> <span class="o">==</span> <span class="s">&#39;color&#39;</span><span class="p">:</span>
                <span class="c"># Parse hex color into RGB values</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nodeValue</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;# </span><span class="se">\n\r</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>

                <span class="c"># Build a message of the form &quot;[RGB]&quot;</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;[&#39;</span><span class="p">,</span> <span class="nb">chr</span><span class="p">(</span><span class="n">red</span><span class="p">),</span> <span class="nb">chr</span><span class="p">(</span><span class="n">green</span><span class="p">),</span> <span class="nb">chr</span><span class="p">(</span><span class="n">blue</span><span class="p">),</span> <span class="s">&#39;#]&#39;</span><span class="p">])</span>

                <span class="c"># Send it to the device</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xbee</span><span class="o">.</span><span class="n">SendData</span><span class="p">(</span><span class="n">dbus</span><span class="o">.</span><span class="n">ByteArray</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">dbus</span><span class="o">.</span><span class="n">UInt64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device_addr</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">ctype</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;on&#39;</span><span class="p">,</span> <span class="s">&#39;off&#39;</span><span class="p">,</span> <span class="s">&#39;shift&#39;</span><span class="p">,</span> <span class="s">&#39;noshift&#39;</span><span class="p">]:</span>
                <span class="n">command_byte</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s">&#39;on&#39;</span> <span class="p">:</span> <span class="s">&#39;@&#39;</span><span class="p">,</span>
                        <span class="s">&#39;off&#39;</span> <span class="p">:</span> <span class="s">&#39;*&#39;</span><span class="p">,</span>
                        <span class="s">&#39;shift&#39;</span> <span class="p">:</span> <span class="s">&#39;$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;noshift&#39;</span> <span class="p">:</span> <span class="s">&#39;|&#39;</span> <span class="p">}[</span><span class="n">ctype</span><span class="p">]</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;[</span><span class="se">\x00\x00\x00</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">command_byte</span><span class="p">,</span> <span class="s">&#39;]&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xbee</span><span class="o">.</span><span class="n">SendData</span><span class="p">(</span><span class="n">dbus</span><span class="o">.</span><span class="n">ByteArray</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">dbus</span><span class="o">.</span><span class="n">UInt64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device_addr</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># emit an error signal for Bridge</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Loops forever and waits for signals from the framework &quot;&quot;&quot;</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">gobject</span><span class="o">.</span><span class="n">MainLoop</span><span class="p">()</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="nd">@dbus.service.signal</span><span class="p">(</span><span class="n">dbus_interface</span><span class="o">=</span><span class="n">turk</span><span class="o">.</span><span class="n">TURK_DRIVER_ERROR</span><span class="p">,</span> <span class="n">signature</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">Error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Called when an error/exception occurs. Emits a signal for any relevant</span>
<span class="sd">            system management daemons and loggers &quot;&quot;&quot;</span>
        <span class="k">pass</span>

<span class="c"># Run as a standalone driver</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="n">device_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;DEVICE_ID&#39;</span><span class="p">))</span>
    <span class="n">device_addr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;DEVICE_ADDRESS&#39;</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">bus</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;BUS&#39;</span><span class="p">,</span> <span class="n">turk</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s">&#39;global.bus&#39;</span><span class="p">))</span>
    <span class="k">print</span> <span class="s">&quot;RGB Lamp driver started... driver id: </span><span class="si">%u</span><span class="s">, target xbee: 0x</span><span class="si">%X</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">device_id</span><span class="p">,</span> <span class="n">device_addr</span><span class="p">)</span>
    <span class="n">dbus</span><span class="o">.</span><span class="n">mainloop</span><span class="o">.</span><span class="n">glib</span><span class="o">.</span><span class="n">DBusGMainLoop</span><span class="p">(</span><span class="n">set_as_default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="n">RGBLamp</span><span class="p">(</span><span class="n">device_id</span><span class="p">,</span> <span class="n">device_addr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dbus</span><span class="p">,</span> <span class="n">bus</span><span class="p">)())</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>There are more examples of drivers included with the framework written in
several other languages, including Ruby, Java, and C++. As D-Bus has bindings
for most commonly used programming languages, this allows developers to
leverage already-written code or libraries to write their drivers. The main
limitation of this approach is the relative lack of support for the Windows
platform, as there is currently no stable port available. However, this
situation should change relatively soon, as the project is still under active
development.</p>
<p>For more detail about writing drivers and the APIs available to them, see
the <a class="reference external" href="driver_connectivity.html#driver-design"><em>Advanced Driver Design</em></a> section.</p>
</div>
</div>
<div class="section" id="writing-and-deploying-a-web-application">
<h2>Writing and deploying a web application<a class="headerlink" href="#writing-and-deploying-a-web-application" title="Permalink to this headline">¶</a></h2>
<p>Creating a web application that uses Turk is even simpler, as they just send
simple XMPP messages to the framework, and only need to be able to process HTTP
POST requests. An application&#8217;s work-flow looks something like this:</p>
<ul class="simple">
<li>Application sends a &#8220;register&#8221; XMPP message to the Turk platform when activated, to
subscribe to any updates from a specified set of drivers.</li>
<li>Application sends &#8220;update&#8221; XMPP messages to the platform on input from the user,
and they are automatically forwarded to the relevant drivers.</li>
<li>Driver sends a new &#8220;update&#8221;, and the framework translates it into a HTTP POST
to the application.</li>
<li>Application is re-activated by the POST, and can choose to send a message back
to the platform through XMPP.</li>
</ul>
<div class="section" id="how-does-it-work">
<h3>How does it work?<a class="headerlink" href="#how-does-it-work" title="Permalink to this headline">¶</a></h3>
<p>The important concept to understand here is that the communication from
application to driver is done through XMPP, whereas drivers send messages back
through HTTP POST requests. Although the content uses the same XML-based
protocol, the transport is different. This is necessary due to the nature of the
client-server model used by most web applications. The web application can&#8217;t
actively listen for XMPP messages, thus requiring HTTP requests to &#8220;wake it up&#8221;,
and the Turk platform likely isn&#8217;t listening on a known internet address,
requiring XMPP messages to &#8220;push&#8221; data to it.</p>
</div>
<div class="section" id="implementation">
<h3>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h3>
<p>The two main difficulties involved in designing an application lie in sending
the XMPP messages and determining when the application registers itself to the
platform. XMPP messages can be easily sent server-side using a variety of
available libraries for languages such as PHP, Python, Ruby and Java. Depending
on the XMPP server used, there are also ways of sending client-side messages
using Javascript and AJAX requests. Some XMPP servers, such as ejabberd and
OpenFire, support an extension called BOSH (Bidirectional-streams Over
Synchronous HTTP), which enables applications to use XMPP through HTTP requests.</p>
<p>The following shows a simple example of sending an XMPP message with PHP and the
<a class="reference external" href="http://code.google.com/p/xmpphp/">XMPPHP library</a>:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">include</span> <span class="s1">&#39;XMPPHP/XMPP.php&#39;</span><span class="p">;</span>

<span class="nv">$platform</span> <span class="o">=</span> <span class="s2">&quot;turk-platform-account@xmpp-server.tld&quot;</span><span class="p">;</span>
<span class="nv">$driver_id</span> <span class="o">=</span> <span class="m">8</span><span class="p">;</span>
<span class="nv">$conn</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMPPHP_XMPP</span><span class="p">(</span><span class="s1">&#39;xmpp-server.tld&#39;</span><span class="p">,</span> <span class="m">5222</span><span class="p">,</span> <span class="s1">&#39;turk-app-account&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;xmpphp&#39;</span><span class="p">);</span>

<span class="k">try</span> <span class="p">{</span>
    <span class="c1"># Connect to server and indicate presence</span>
    <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">connect</span><span class="p">();</span>
    <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">processUntil</span><span class="p">(</span><span class="s1">&#39;session_start&#39;</span><span class="p">);</span>
    <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">presence</span><span class="p">();</span>

    <span class="c1"># Build update message containing simple XML command</span>
    <span class="nv">$msg</span> <span class="o">=</span> <span class="s1">&#39;&lt;message xmlns=&quot;jabber:client&quot; to=&quot;&#39;</span><span class="o">.</span><span class="nv">$platform</span><span class="o">.</span><span class="s1">&#39;&quot;&gt;&#39;</span><span class="p">;</span>
    <span class="nv">$msg</span> <span class="o">.=</span> <span class="s1">&#39;&lt;update xmlns=&quot;http://turkinnovations.com/protocol&quot; to=&quot;&#39;</span><span class="o">.</span><span class="nv">$driver_id</span><span class="o">.</span><span class="s1">&#39;&quot; from=&quot;0&quot;&gt;&#39;</span><span class="p">;</span>
    <span class="nv">$msg</span> <span class="o">.=</span> <span class="s1">&#39;&lt;command type=&quot;on&quot; /&gt;&#39;</span><span class="p">;</span>
    <span class="nv">$msg</span> <span class="o">.=</span> <span class="s1">&#39;&lt;/update&gt;&#39;</span><span class="p">;</span>
    <span class="nv">$msg</span> <span class="o">.=</span> <span class="s1">&#39;&lt;/message&gt;&#39;</span><span class="p">;</span>

    <span class="c1"># Send message and close the connection</span>
    <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nv">$msg</span><span class="p">);</span>
    <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">disconnect</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">XMPPHP_Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">die</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>Running this script on your server will send the following XMPP message to
<a class="reference external" href="mailto:turk-platform-account&#37;&#52;&#48;xmpp-server&#46;tld">turk-platform-account<span>&#64;</span>xmpp-server<span>&#46;</span>tld</a> (the XMPP JID the platform
is using).</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;message</span> <span class="na">xmlns=</span><span class="s">&quot;jabber:client&quot;</span> <span class="na">to=</span><span class="s">&quot;turk-platform-account@xmpp-server.tld&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;update</span> <span class="na">xmlns=</span><span class="s">&quot;http://turkinnovations.com/protocol&quot;</span> <span class="na">to=</span><span class="s">&quot;8&quot;</span> <span class="na">from=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;command</span> <span class="na">type=</span><span class="s">&quot;on&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/update&gt;</span>
<span class="nt">&lt;/message&gt;</span>
</pre></div>
</div>
<p>In this case, the &#8220;update&#8221; stanza is interpreted by the Turk
framework as a request to forward data to a driver. The &#8220;to&#8221; attribute holds the
ID of the driver to send it to. The &#8220;command&#8221; stanza (and anything else inside
the update) is custom data for the driver to receive, and can be anything,
including text or binary data, as long as it is properly escaped or encoded as
XML.</p>
<p>For the application to receive data back from the driver, it needs to provide
the platform with a URL to connect back to. Subscribing to a driver&#8217;s updates is
done by sending a &#8220;register&#8221; to the platform.</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;message</span> <span class="na">xmlns=</span><span class="s">&quot;jabber:client&quot;</span> <span class="na">to=</span><span class="s">&quot;turk-platform-account@xmpp-server.tld&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;register</span> <span class="na">xmlns=</span><span class="s">&quot;http://turkinnovations.com/protocol&quot;</span> <span class="na">app=</span><span class="s">&quot;2&quot;</span> <span class="na">url=</span><span class="s">&quot;http://example.com/updates/&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;driver</span> <span class="na">id=</span><span class="s">&quot;8&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/register&gt;</span>
<span class="nt">&lt;/message&gt;</span>
</pre></div>
</div>
<p>This notifies the platform that any updates from driver #8 should be sent to
&#8220;<a class="reference external" href="http://example.com/updates/">http://example.com/updates/</a>&#8221; as an HTTP POST request. The data from the
driver will be wrapped up in a &#8220;update&#8221; stanza, with the &#8220;to&#8221; and &#8220;from&#8221; fields
automatically filled in.</p>
<div class="highlight-xml"><div class="highlight"><pre>POST /update/ HTTP/1.1
Host: example.com
User-Agent: TurkFramework/0.12
Content-Type: application/xml; charset=utf-8
Content-Length: 268

<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;update</span> <span class="na">xmlns=</span><span class="s">&quot;http://turkinnovations.com/protocol&quot;</span> <span class="na">to=</span><span class="s">&quot;0&quot;</span> <span class="na">from=</span><span class="s">&quot;8&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;status&gt;</span>OK<span class="nt">&lt;/status&gt;</span>
<span class="nt">&lt;/update&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="deploying-an-application">
<h3>Deploying an Application<a class="headerlink" href="#deploying-an-application" title="Permalink to this headline">¶</a></h3>
<p>Although applications can send messages to a Turk platform from anywhere in the
world through the internet, they need to have a well-known, publically visible
URL for Turk to send updates back. To get around this limitation, there will
most likely be an update to the protocol allowing applications to register their
XMPP JID (e.g. &#8220;<a class="reference external" href="mailto:turk-app-account&#37;&#52;&#48;xmpp-server&#46;tld">turk-app-account<span>&#64;</span>xmpp-server<span>&#46;</span>tld</a>&#8220;) instead of a URL, so that
they will receive updates as XMPP messages. This will also be useful for
client-side Javascript applications, as they will be able to send and receive
data from the platform without involving the web server at all!</p>
<p>However, the most common usage is to have the application hosted somewhere on
the web, with server-side scripts doing the XMPP and HTTP processing. This is
the simplest method, and allows the application to store semi-permanent state
information about the drivers it controls.</p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="yaml" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>YAML: YAML Ain&#8217;t Markup Language (see <a class="reference external" href="http://yaml.org">yaml.org</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="jid" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>JID: Jabber ID, a unique identifier for a user on an XMPP server. Structured like an email address (<a class="reference external" href="mailto:username&#37;&#52;&#48;host&#46;tld">username<span>&#64;</span>host<span>&#46;</span>tld</a>)</td></tr>
</tbody>
</table>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="#">Getting started with the Turk Framework</a><ul>
<li><a class="reference external" href="#installing">Installing</a></li>
<li><a class="reference external" href="#setting-up-the-configuration">Setting up the configuration</a><ul>
<li><a class="reference external" href="#why-use-yaml">Why use YAML?</a></li>
<li><a class="reference external" href="#example-configuration">Example Configuration</a></li>
</ul>
</li>
<li><a class="reference external" href="#writing-a-simple-driver">Writing a simple driver</a><ul>
<li><a class="reference external" href="#example-driver">Example Driver</a></li>
</ul>
</li>
<li><a class="reference external" href="#writing-and-deploying-a-web-application">Writing and deploying a web application</a><ul>
<li><a class="reference external" href="#how-does-it-work">How does it work?</a></li>
<li><a class="reference external" href="#implementation">Implementation</a></li>
<li><a class="reference external" href="#deploying-an-application">Deploying an Application</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="overview.html"
                                  title="previous chapter">Overview</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="configuration.html"
                                  title="next chapter">Configuring Turk</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/getting_started.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="configuration.html" title="Configuring Turk"
             >next</a> |</li>
        <li class="right" >
          <a href="overview.html" title="Overview"
             >previous</a> |</li>
        <li><a href="index.html">Turk v0.1.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2010, Rob O&#39;Dwyer.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.4.
    </div>
  </body>
</html>